function [u_sol,u_exact] = task52d(N)

addpath ..\Grids
addpath ..\Oppgave1

[p,tri,edge] = getPlate(N);
f= @(x,y,E,v) E/(1-v^2) * [-2*y.^2 + x.^2*(v-1) - 2*x.*y*(v+1) + 3 - v;
                          -2*x.^2 + y.^2*(v-1) - 2*x.*y*(v+1) + 3 - v];
Ak =  @(E,v,p1,p2,p3)reshape([(E.*1.0./(p1(1).*p2(2)-p2(1).*p1(2)-p1(1).*p3(2)+p3(1).*p1(2)+p2(1).*p3(2)-p3(1).*p2(2)).^3.*(p2(1).*p3(1).*-2.0-p2(2).*p3(2).*2.0-v.*p2(1).^2-v.*p3(1).^2+p2(1).^2+p3(1).^2+p2(2).^2+p3(2).^2+v.*p2(1).*p3(1).*2.0).*(-1.0./2.0))./(v.^2-1.0),(E.*(p2(1)-p3(1)).*(p2(2)-p3(2)).*1.0./(p1(1).*p2(2)-p2(1).*p1(2)-p1(1).*p3(2)+p3(1).*p1(2)+p2(1).*p3(2)-p3(1).*p2(2)).^3.*(1.0./2.0))./(v.^2-1.0),(E.*1.0./(p1(1).*p2(2)-p2(1).*p1(2)-p1(1).*p3(2)+p3(1).*p1(2)+p2(1).*p3(2)-p3(1).*p2(2)).^3.*(p1(1).*p2(1)-p1(1).*p3(1)-p2(1).*p3(1)+p1(2).*p2(2)-p1(2).*p3(2)-p2(2).*p3(2)-v.*p3(1).^2+p3(1).^2+p3(2).^2-v.*p1(1).*p2(1)+v.*p1(1).*p3(1)+v.*p2(1).*p3(1)).*(1.0./2.0))./(v.^2-1.0),(E.*1.0./(p1(1).*p2(2)-p2(1).*p1(2)-p1(1).*p3(2)+p3(1).*p1(2)+p2(1).*p3(2)-p3(1).*p2(2)).^3.*(p2(1).*p1(2)-p3(1).*p1(2)-p2(1).*p3(2)+p3(1).*p3(2)+v.*p1(1).*p2(2)-v.*p2(1).*p1(2)-v.*p1(1).*p3(2)+v.*p3(1).*p1(2)+v.*p2(1).*p3(2)-v.*p3(1).*p2(2)).*(-1.0./2.0))./(v.^2-1.0),(E.*1.0./(p1(1).*p2(2)-p2(1).*p1(2)-p1(1).*p3(2)+p3(1).*p1(2)+p2(1).*p3(2)-p3(1).*p2(2)).^3.*(p1(1).*p2(1)-p1(1).*p3(1)+p2(1).*p3(1)+p1(2).*p2(2)-p1(2).*p3(2)+p2(2).*p3(2)+v.*p2(1).^2-p2(1).^2-p2(2).^2-v.*p1(1).*p2(1)+v.*p1(1).*p3(1)-v.*p2(1).*p3(1)).*(-1.0./2.0))./(v.^2-1.0),(E.*1.0./(p1(1).*p2(2)-p2(1).*p1(2)-p1(1).*p3(2)+p3(1).*p1(2)+p2(1).*p3(2)-p3(1).*p2(2)).^3.*(p2(1).*p1(2)-p2(1).*p2(2)-p3(1).*p1(2)+p3(1).*p2(2)+v.*p1(1).*p2(2)-v.*p2(1).*p1(2)-v.*p1(1).*p3(2)+v.*p3(1).*p1(2)+v.*p2(1).*p3(2)-v.*p3(1).*p2(2)).*(1.0./2.0))./(v.^2-1.0),(E.*(p2(1)-p3(1)).*(p2(2)-p3(2)).*1.0./(p1(1).*p2(2)-p2(1).*p1(2)-p1(1).*p3(2)+p3(1).*p1(2)+p2(1).*p3(2)-p3(1).*p2(2)).^3.*(1.0./2.0))./(v.^2-1.0),(E.*1.0./(p1(1).*p2(2)-p2(1).*p1(2)-p1(1).*p3(2)+p3(1).*p1(2)+p2(1).*p3(2)-p3(1).*p2(2)).^3.*(p2(1).*p3(1).*-2.0-p2(2).*p3(2).*2.0-v.*p2(2).^2-v.*p3(2).^2+p2(1).^2+p3(1).^2+p2(2).^2+p3(2).^2+v.*p2(2).*p3(2).*2.0).*(-1.0./2.0))./(v.^2-1.0),(E.*1.0./(p1(1).*p2(2)-p2(1).*p1(2)-p1(1).*p3(2)+p3(1).*p1(2)+p2(1).*p3(2)-p3(1).*p2(2)).^3.*(p1(1).*p2(2)-p1(1).*p3(2)-p3(1).*p2(2)+p3(1).*p3(2)-v.*p1(1).*p2(2)+v.*p2(1).*p1(2)+v.*p1(1).*p3(2)-v.*p3(1).*p1(2)-v.*p2(1).*p3(2)+v.*p3(1).*p2(2)).*(-1.0./2.0))./(v.^2-1.0),(E.*1.0./(p1(1).*p2(2)-p2(1).*p1(2)-p1(1).*p3(2)+p3(1).*p1(2)+p2(1).*p3(2)-p3(1).*p2(2)).^3.*(p1(1).*p2(1)-p1(1).*p3(1)-p2(1).*p3(1)+p1(2).*p2(2)-p1(2).*p3(2)-p2(2).*p3(2)-v.*p3(2).^2+p3(1).^2+p3(2).^2-v.*p1(2).*p2(2)+v.*p1(2).*p3(2)+v.*p2(2).*p3(2)).*(1.0./2.0))./(v.^2-1.0),(E.*1.0./(p1(1).*p2(2)-p2(1).*p1(2)-p1(1).*p3(2)+p3(1).*p1(2)+p2(1).*p3(2)-p3(1).*p2(2)).^3.*(p1(1).*p2(2)-p1(1).*p3(2)-p2(1).*p2(2)+p2(1).*p3(2)-v.*p1(1).*p2(2)+v.*p2(1).*p1(2)+v.*p1(1).*p3(2)-v.*p3(1).*p1(2)-v.*p2(1).*p3(2)+v.*p3(1).*p2(2)).*(1.0./2.0))./(v.^2-1.0),(E.*1.0./(p1(1).*p2(2)-p2(1).*p1(2)-p1(1).*p3(2)+p3(1).*p1(2)+p2(1).*p3(2)-p3(1).*p2(2)).^3.*(p1(1).*p2(1)-p1(1).*p3(1)+p2(1).*p3(1)+p1(2).*p2(2)-p1(2).*p3(2)+p2(2).*p3(2)+v.*p2(2).^2-p2(1).^2-p2(2).^2-v.*p1(2).*p2(2)+v.*p1(2).*p3(2)-v.*p2(2).*p3(2)).*(-1.0./2.0))./(v.^2-1.0),(E.*1.0./(p1(1).*p2(2)-p2(1).*p1(2)-p1(1).*p3(2)+p3(1).*p1(2)+p2(1).*p3(2)-p3(1).*p2(2)).^3.*(p1(1).*p2(1)-p1(1).*p3(1)-p2(1).*p3(1)+p1(2).*p2(2)-p1(2).*p3(2)-p2(2).*p3(2)-v.*p3(1).^2+p3(1).^2+p3(2).^2-v.*p1(1).*p2(1)+v.*p1(1).*p3(1)+v.*p2(1).*p3(1)).*(1.0./2.0))./(v.^2-1.0),(E.*1.0./(p1(1).*p2(2)-p2(1).*p1(2)-p1(1).*p3(2)+p3(1).*p1(2)+p2(1).*p3(2)-p3(1).*p2(2)).^3.*(p1(1).*p2(2)-p1(1).*p3(2)-p3(1).*p2(2)+p3(1).*p3(2)-v.*p1(1).*p2(2)+v.*p2(1).*p1(2)+v.*p1(1).*p3(2)-v.*p3(1).*p1(2)-v.*p2(1).*p3(2)+v.*p3(1).*p2(2)).*(-1.0./2.0))./(v.^2-1.0),(E.*1.0./(p1(1).*p2(2)-p2(1).*p1(2)-p1(1).*p3(2)+p3(1).*p1(2)+p2(1).*p3(2)-p3(1).*p2(2)).^3.*(p1(1).*p3(1).*-2.0-p1(2).*p3(2).*2.0-v.*p1(1).^2-v.*p3(1).^2+p1(1).^2+p3(1).^2+p1(2).^2+p3(2).^2+v.*p1(1).*p3(1).*2.0).*(-1.0./2.0))./(v.^2-1.0),(E.*(p1(1)-p3(1)).*(p1(2)-p3(2)).*1.0./(p1(1).*p2(2)-p2(1).*p1(2)-p1(1).*p3(2)+p3(1).*p1(2)+p2(1).*p3(2)-p3(1).*p2(2)).^3.*(1.0./2.0))./(v.^2-1.0),(E.*1.0./(p1(1).*p2(2)-p2(1).*p1(2)-p1(1).*p3(2)+p3(1).*p1(2)+p2(1).*p3(2)-p3(1).*p2(2)).^3.*(p1(1).*p2(1)+p1(1).*p3(1)-p2(1).*p3(1)+p1(2).*p2(2)+p1(2).*p3(2)-p2(2).*p3(2)+v.*p1(1).^2-p1(1).^2-p1(2).^2-v.*p1(1).*p2(1)-v.*p1(1).*p3(1)+v.*p2(1).*p3(1)).*(-1.0./2.0))./(v.^2-1.0),(E.*1.0./(p1(1).*p2(2)-p2(1).*p1(2)-p1(1).*p3(2)+p3(1).*p1(2)+p2(1).*p3(2)-p3(1).*p2(2)).^3.*(p1(1).*p1(2)-p1(1).*p2(2)-p3(1).*p1(2)+p3(1).*p2(2)+v.*p1(1).*p2(2)-v.*p2(1).*p1(2)-v.*p1(1).*p3(2)+v.*p3(1).*p1(2)+v.*p2(1).*p3(2)-v.*p3(1).*p2(2)).*(-1.0./2.0))./(v.^2-1.0),(E.*1.0./(p1(1).*p2(2)-p2(1).*p1(2)-p1(1).*p3(2)+p3(1).*p1(2)+p2(1).*p3(2)-p3(1).*p2(2)).^3.*(p2(1).*p1(2)-p3(1).*p1(2)-p2(1).*p3(2)+p3(1).*p3(2)+v.*p1(1).*p2(2)-v.*p2(1).*p1(2)-v.*p1(1).*p3(2)+v.*p3(1).*p1(2)+v.*p2(1).*p3(2)-v.*p3(1).*p2(2)).*(-1.0./2.0))./(v.^2-1.0),(E.*1.0./(p1(1).*p2(2)-p2(1).*p1(2)-p1(1).*p3(2)+p3(1).*p1(2)+p2(1).*p3(2)-p3(1).*p2(2)).^3.*(p1(1).*p2(1)-p1(1).*p3(1)-p2(1).*p3(1)+p1(2).*p2(2)-p1(2).*p3(2)-p2(2).*p3(2)-v.*p3(2).^2+p3(1).^2+p3(2).^2-v.*p1(2).*p2(2)+v.*p1(2).*p3(2)+v.*p2(2).*p3(2)).*(1.0./2.0))./(v.^2-1.0),(E.*(p1(1)-p3(1)).*(p1(2)-p3(2)).*1.0./(p1(1).*p2(2)-p2(1).*p1(2)-p1(1).*p3(2)+p3(1).*p1(2)+p2(1).*p3(2)-p3(1).*p2(2)).^3.*(1.0./2.0))./(v.^2-1.0),(E.*1.0./(p1(1).*p2(2)-p2(1).*p1(2)-p1(1).*p3(2)+p3(1).*p1(2)+p2(1).*p3(2)-p3(1).*p2(2)).^3.*(p1(1).*p3(1).*-2.0-p1(2).*p3(2).*2.0-v.*p1(2).^2-v.*p3(2).^2+p1(1).^2+p3(1).^2+p1(2).^2+p3(2).^2+v.*p1(2).*p3(2).*2.0).*(-1.0./2.0))./(v.^2-1.0),(E.*1.0./(p1(1).*p2(2)-p2(1).*p1(2)-p1(1).*p3(2)+p3(1).*p1(2)+p2(1).*p3(2)-p3(1).*p2(2)).^3.*(p1(1).*p1(2)-p2(1).*p1(2)-p1(1).*p3(2)+p2(1).*p3(2)-v.*p1(1).*p2(2)+v.*p2(1).*p1(2)+v.*p1(1).*p3(2)-v.*p3(1).*p1(2)-v.*p2(1).*p3(2)+v.*p3(1).*p2(2)).*(-1.0./2.0))./(v.^2-1.0),(E.*1.0./(p1(1).*p2(2)-p2(1).*p1(2)-p1(1).*p3(2)+p3(1).*p1(2)+p2(1).*p3(2)-p3(1).*p2(2)).^3.*(p1(1).*p2(1)+p1(1).*p3(1)-p2(1).*p3(1)+p1(2).*p2(2)+p1(2).*p3(2)-p2(2).*p3(2)+v.*p1(2).^2-p1(1).^2-p1(2).^2-v.*p1(2).*p2(2)-v.*p1(2).*p3(2)+v.*p2(2).*p3(2)).*(-1.0./2.0))./(v.^2-1.0),(E.*1.0./(p1(1).*p2(2)-p2(1).*p1(2)-p1(1).*p3(2)+p3(1).*p1(2)+p2(1).*p3(2)-p3(1).*p2(2)).^3.*(p1(1).*p2(1)-p1(1).*p3(1)+p2(1).*p3(1)+p1(2).*p2(2)-p1(2).*p3(2)+p2(2).*p3(2)+v.*p2(1).^2-p2(1).^2-p2(2).^2-v.*p1(1).*p2(1)+v.*p1(1).*p3(1)-v.*p2(1).*p3(1)).*(-1.0./2.0))./(v.^2-1.0),(E.*1.0./(p1(1).*p2(2)-p2(1).*p1(2)-p1(1).*p3(2)+p3(1).*p1(2)+p2(1).*p3(2)-p3(1).*p2(2)).^3.*(p1(1).*p2(2)-p1(1).*p3(2)-p2(1).*p2(2)+p2(1).*p3(2)-v.*p1(1).*p2(2)+v.*p2(1).*p1(2)+v.*p1(1).*p3(2)-v.*p3(1).*p1(2)-v.*p2(1).*p3(2)+v.*p3(1).*p2(2)).*(1.0./2.0))./(v.^2-1.0),(E.*1.0./(p1(1).*p2(2)-p2(1).*p1(2)-p1(1).*p3(2)+p3(1).*p1(2)+p2(1).*p3(2)-p3(1).*p2(2)).^3.*(p1(1).*p2(1)+p1(1).*p3(1)-p2(1).*p3(1)+p1(2).*p2(2)+p1(2).*p3(2)-p2(2).*p3(2)+v.*p1(1).^2-p1(1).^2-p1(2).^2-v.*p1(1).*p2(1)-v.*p1(1).*p3(1)+v.*p2(1).*p3(1)).*(-1.0./2.0))./(v.^2-1.0),(E.*1.0./(p1(1).*p2(2)-p2(1).*p1(2)-p1(1).*p3(2)+p3(1).*p1(2)+p2(1).*p3(2)-p3(1).*p2(2)).^3.*(p1(1).*p1(2)-p2(1).*p1(2)-p1(1).*p3(2)+p2(1).*p3(2)-v.*p1(1).*p2(2)+v.*p2(1).*p1(2)+v.*p1(1).*p3(2)-v.*p3(1).*p1(2)-v.*p2(1).*p3(2)+v.*p3(1).*p2(2)).*(-1.0./2.0))./(v.^2-1.0),(E.*1.0./(p1(1).*p2(2)-p2(1).*p1(2)-p1(1).*p3(2)+p3(1).*p1(2)+p2(1).*p3(2)-p3(1).*p2(2)).^3.*(p1(1).*p2(1).*-2.0-p1(2).*p2(2).*2.0-v.*p1(1).^2-v.*p2(1).^2+p1(1).^2+p2(1).^2+p1(2).^2+p2(2).^2+v.*p1(1).*p2(1).*2.0).*(-1.0./2.0))./(v.^2-1.0),(E.*(p1(1)-p2(1)).*(p1(2)-p2(2)).*1.0./(p1(1).*p2(2)-p2(1).*p1(2)-p1(1).*p3(2)+p3(1).*p1(2)+p2(1).*p3(2)-p3(1).*p2(2)).^3.*(1.0./2.0))./(v.^2-1.0),(E.*1.0./(p1(1).*p2(2)-p2(1).*p1(2)-p1(1).*p3(2)+p3(1).*p1(2)+p2(1).*p3(2)-p3(1).*p2(2)).^3.*(p2(1).*p1(2)-p2(1).*p2(2)-p3(1).*p1(2)+p3(1).*p2(2)+v.*p1(1).*p2(2)-v.*p2(1).*p1(2)-v.*p1(1).*p3(2)+v.*p3(1).*p1(2)+v.*p2(1).*p3(2)-v.*p3(1).*p2(2)).*(1.0./2.0))./(v.^2-1.0),(E.*1.0./(p1(1).*p2(2)-p2(1).*p1(2)-p1(1).*p3(2)+p3(1).*p1(2)+p2(1).*p3(2)-p3(1).*p2(2)).^3.*(p1(1).*p2(1)-p1(1).*p3(1)+p2(1).*p3(1)+p1(2).*p2(2)-p1(2).*p3(2)+p2(2).*p3(2)+v.*p2(2).^2-p2(1).^2-p2(2).^2-v.*p1(2).*p2(2)+v.*p1(2).*p3(2)-v.*p2(2).*p3(2)).*(-1.0./2.0))./(v.^2-1.0),(E.*1.0./(p1(1).*p2(2)-p2(1).*p1(2)-p1(1).*p3(2)+p3(1).*p1(2)+p2(1).*p3(2)-p3(1).*p2(2)).^3.*(p1(1).*p1(2)-p1(1).*p2(2)-p3(1).*p1(2)+p3(1).*p2(2)+v.*p1(1).*p2(2)-v.*p2(1).*p1(2)-v.*p1(1).*p3(2)+v.*p3(1).*p1(2)+v.*p2(1).*p3(2)-v.*p3(1).*p2(2)).*(-1.0./2.0))./(v.^2-1.0),(E.*1.0./(p1(1).*p2(2)-p2(1).*p1(2)-p1(1).*p3(2)+p3(1).*p1(2)+p2(1).*p3(2)-p3(1).*p2(2)).^3.*(p1(1).*p2(1)+p1(1).*p3(1)-p2(1).*p3(1)+p1(2).*p2(2)+p1(2).*p3(2)-p2(2).*p3(2)+v.*p1(2).^2-p1(1).^2-p1(2).^2-v.*p1(2).*p2(2)-v.*p1(2).*p3(2)+v.*p2(2).*p3(2)).*(-1.0./2.0))./(v.^2-1.0),(E.*(p1(1)-p2(1)).*(p1(2)-p2(2)).*1.0./(p1(1).*p2(2)-p2(1).*p1(2)-p1(1).*p3(2)+p3(1).*p1(2)+p2(1).*p3(2)-p3(1).*p2(2)).^3.*(1.0./2.0))./(v.^2-1.0),(E.*1.0./(p1(1).*p2(2)-p2(1).*p1(2)-p1(1).*p3(2)+p3(1).*p1(2)+p2(1).*p3(2)-p3(1).*p2(2)).^3.*(p1(1).*p2(1).*-2.0-p1(2).*p2(2).*2.0-v.*p1(2).^2-v.*p2(2).^2+p1(1).^2+p2(1).^2+p1(2).^2+p2(2).^2+v.*p1(2).*p2(2).*2.0).*(-1.0./2.0))./(v.^2-1.0)],[6,6]);

N = length(tri);
A = spalloc(2*N,2*N,10*N);
E = 1;
v = 0.3;
for i = 1:length(tri)
    p1 = p(tri(i,1),:)'; p2 = p(tri(i,2),:)'; p3 = p(tri(i,3),:)';
    tempIndices = [2*(tri(i,:));2*(tri(i,:))+1];
    indices = tempIndices(:);
    A(indices,indices) = A(indices,indices) + Ak(E,v,p1,p2,p3);
end

y = (~ismember(tri,edge)).*tri;
inner_vertices_2 = unique(y);
inner_vertices_2 = inner_vertices_2(2:end);

tempIV = [2*(inner_vertices_2);2*(inner_vertices_2)+1];
inner_vertices = tempIV(:);

A = A(inner_vertices,inner_vertices);


end
    